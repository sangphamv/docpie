---
import ListLayout from "@/layouts/list.astro";
import { getEntry } from "astro:content";
import { categoriesHandler } from "@/lib/handlers/categories";
import NewsCard from "@/components/cards/newsCard.astro";
import ArrowRight02 from "@/assets/svgs/arrow-right-02.astro";

const entry = await getEntry("views", "categories");

if (!entry) {
  return Astro.redirect("/404");
}

// Fetch all articles to extract categories
const articles = categoriesHandler.allCategoriesWithLatestArticles();
---

<ListLayout header={"All Categories"} entry={entry}>
  <div class="w-full space-y-12 my-8">
    {
      articles.map((category, catIndex) => {
        const { path, title, latestArticles } = category.data;
        const articleCount = category.data.count;
        return (
          <section class="category-section">
            {/* Category Header */}
            <div class="flex items-center justify-between gap-4 mb-6 pb-3 border-b-2 border-primary">
              <div class="flex items-baseline gap-3">
                <h2 class="text-2xl md:text-3xl font-bold text-base-content">
                  {title}
                </h2>
                <span class="badge badge-primary">
                  {articleCount} {articleCount === 1 ? 'Article' : 'Articles'}
                </span>
              </div>
              <a
                href={`/categories/${path}/1`}
                class="group flex items-center gap-2 text-sm font-semibold text-primary hover:text-primary transition-all duration-200 hover:gap-3"
              >
                View All
                <span class="transition-transform duration-200 group-hover:translate-x-1">
                  <ArrowRight02 size="18" />
                </span>
              </a>
            </div>

            {/* Articles Grid - Desktop: 3 columns, Mobile: Horizontal scroll */}
            <div class="articles-container">
              {/* Mobile: Horizontal Scroll */}
              <div class="md:hidden flex overflow-x-auto gap-4 pb-4 snap-x snap-mandatory scrollbar-hide">
                {latestArticles.slice(0, 8).map((article, index) => (
                  <div class="snap-start flex-none w-[280px] sm:w-[320px]">
                    <NewsCard article={article} index={catIndex === 0 && index < 3 ? index : index + 3} />
                  </div>
                ))}
              </div>

              {/* Desktop: Grid */}
              <div class="hidden md:grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {latestArticles.slice(0, 6).map((article, index) => (
                  <NewsCard article={article} index={catIndex === 0 && index < 3 ? index : index + 3} />
                ))}
              </div>
            </div>
          </section>
        );
      })
    }
  </div>

  <style>
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .category-section {
      scroll-margin-top: 2rem;
    }

    .articles-container {
      position: relative;
    }

    /* Fade effect for horizontal scroll */
    @media (max-width: 768px) {
      .articles-container::after {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 1rem;
        width: 3rem;
        background: linear-gradient(to left, var(--bg-page), transparent);
        pointer-events: none;
      }
    }
  </style>
</ListLayout>
