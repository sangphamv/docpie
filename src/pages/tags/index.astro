---
import ListLayout from "@/layouts/list.astro";
import { getEntry } from "astro:content";
import { tagsHandler } from "@/lib/handlers/tags";
import { articlesHandler } from "@/lib/handlers/articles";
import NewsCard from "@/components/cards/newsCard.astro";

const entry = await getEntry("views", "tags");

if (!entry) {
  return Astro.redirect("/404");
}

const tags = tagsHandler.allTagsWithCount();
const selectedSlug = Astro.url.searchParams.get("tag");
const selectedTag = selectedSlug
  ? tags.find((tag) => tag.data.path === selectedSlug || tag.id === selectedSlug)
  : null;
const filteredArticles = selectedTag
  ? tagsHandler.articlesByTagId(selectedTag.id)
  : articlesHandler.allArticles();
---

<ListLayout header={"All Tags"} entry={entry}>
  <div class="space-y-8">
    <div class="flex flex-wrap gap-3">
      <a
        href="/tags"
        class={`btn btn-sm ${
          !selectedTag
            ? "btn-primary"
            : "btn-ghost border border-base-300"
        }`}
      >
        Tất cả
        <span class="badge badge-sm badge-primary">
          {filteredArticles.length}
        </span>
      </a>
      {tags.map((tag) => (
        <a
          href={`/tags?tag=${tag.data.path}`}
          class={`btn btn-sm ${
            selectedTag && selectedTag.id === tag.id
              ? "btn-primary"
              : "btn-ghost border border-base-300"
          }`}
        >
          <span>{tag.data.title}</span>
          <span class="badge badge-sm badge-primary">
            {tag.data.count}
          </span>
        </a>
      ))}
    </div>

    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
      {filteredArticles.length === 0 ? (
        <p class="text-base-content/70">Không có bài viết cho thẻ này.</p>
      ) : (
        filteredArticles.map((article, index) => (
          <NewsCard article={article} index={index} />
        ))
      )}
    </div>
  </div>
</ListLayout>
