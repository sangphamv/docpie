---
import { Image } from "astro:assets";
import HeaderSection from "./headerSection.astro";
import { articlesHandler } from "@/lib/handlers/articles";
import { categoriesHandler } from "@/lib/handlers/categories";
import { tagsHandler } from "@/lib/handlers/tags";
import { render } from "astro:content";
import { CONSTANTS } from "@/lib/config";
import Divider from "@/components/bases/divider.astro";

const items = articlesHandler.allArticles().slice(0, 6);
---

<section
  class="py-12"
  data-pagefind-ignore="all"
>
  <div class="container space-y-6">
    <HeaderSection
      title={CONSTANTS.Parallax_Showcase_Title}
      link_title={CONSTANTS.Parallax_Showcase_CTA}
      link_url="/articles"
    />

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">
      {
        items.map(async (article) => {
          const category = categoriesHandler.oneCategory(
            article.data.category.id
          ) as any;
          const tags = (article.data.tags ?? []).map(tag => tagsHandler.oneTag(tag.id));
          const { remarkPluginFrontmatter } = await render(article);
          return (
            <article class="group h-full" data-parallax-card>
              <a
                href={`/articles/${article.id}`}
                class="parallax-inner h-full flex flex-col overflow-hidden bg-base-100 rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
              >
                <div
                  class="relative aspect-video"
                  data-skeleton
                  data-loaded="false"
                >
                  <Image
                    src={article.data.cover}
                    alt={article.data.covert_alt || article.data.title}
                    layout="constrained"
                    loading="lazy"
                    format="avif"
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                  />
                </div>
                <div class="p-4 space-y-2 flex-1 flex flex-col text-left">
                  <div class="flex items-center flex-wrap text-xs tracking-wide opacity-70 gap-2">
                    <span class="text-base-content"> 
                      {category?.data?.title ??
                        category?.data?.name ??
                        category?.title ??
                        category?.name ??
                        article.data.category.id}
                    </span>
                    {tags.length > 0 && (
                      <>
                        <Divider />
                        <div class="flex items-center gap-1.5">
                          {tags.slice(0, 2).map((tag) => (
                            <span class="text-base-content font-medium tracking-wide">
                              {tag.data.title}
                            </span>
                          ))}
                        </div>
                      </>
                    )}
                    <Divider />
                    <span class="text-base-content">{remarkPluginFrontmatter.minutesRead}</span>
                  </div>
                  <h3 class="text-base md:text-lg font-semibold text-primary leading-snug line-clamp-2">
                    {article.data.title}
                  </h3>
                  <p class="text-sm opacity-70 line-clamp-2 flex-1 text-base-content">
                    {article.data.description}
                  </p>
                </div>
              </a>
            </article>
          );
        })
      }
    </div>
  </div>
</section>

<style>
  [data-parallax-card] {
    perspective: 1200px;
  }

  [data-parallax-card] .parallax-inner {
    transform: translateY(var(--lift, 0px)) rotateX(var(--tilt-x, 0deg))
      rotateY(var(--tilt-y, 0deg));
    will-change: transform;
  }

  [data-skeleton] {
    position: relative;
    overflow: hidden;
    background: color-mix(in oklab, var(--bg-subtle) 70%, var(--text-muted) 6%);
  }

  [data-skeleton]::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      90deg,
      color-mix(in oklab, var(--bg-subtle) 80%, var(--text-muted) 5%) 0%,
      color-mix(in oklab, var(--bg-subtle) 70%, white 10%) 50%,
      color-mix(in oklab, var(--bg-subtle) 80%, var(--text-muted) 5%) 100%
    );
    transform: translateX(-100%);
    animation: shimmer 1.1s ease-in-out infinite;
  }

  [data-skeleton][data-loaded="true"]::before {
    opacity: 0;
    visibility: hidden;
    animation: none;
  }

  @keyframes shimmer {
    to {
      transform: translateX(100%);
    }
  }
</style>

<script type="module">
  // @ts-nocheck
  const cards = Array.from(document.querySelectorAll("[data-parallax-card]"));
  const reduceMotion = window.matchMedia(
    "(prefers-reduced-motion: reduce)"
  ).matches;

  if (!reduceMotion && cards.length) {
    const maxTilt = 6;
    const lift = 6;

    const reset = (card) => {
      card.style.setProperty("--tilt-x", "0deg");
      card.style.setProperty("--tilt-y", "0deg");
      card.style.setProperty("--lift", "0px");
    };

    const handleMove = (card, event) => {
      const rect = card.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const halfW = rect.width / 2;
      const halfH = rect.height / 2;
      const tiltY = ((x - halfW) / halfW) * maxTilt;
      const tiltX = ((halfH - y) / halfH) * maxTilt;
      card.style.setProperty("--tilt-x", `${tiltX}deg`);
      card.style.setProperty("--tilt-y", `${tiltY}deg`);
      card.style.setProperty("--lift", `${lift}px`);
    };

    cards.forEach((card) => {
      card.addEventListener("pointermove", (event) => handleMove(card, event));
      card.addEventListener("pointerleave", () => reset(card));
      card.addEventListener("pointerenter", () =>
        card.style.setProperty("--lift", `${lift}px`)
      );
    });
  }
</script>
