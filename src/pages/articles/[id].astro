---
import { render } from "astro:content";
import BaseLayout from "@/layouts/base.astro";
import ContentLayout from "@/layouts/content.astro";
import Breadcrumb from "@/components/bases/breadcrumb.astro";
import ArticleHeader from "./_components/article-header.astro";
import ArticleLink from "./_components/article-link.astro";
import ArticleSidebar from "./_components/article-sidebar.astro";
import Giscus from "@/components/bases/giscus.astro";
import ReadingProgress from "@/components/bases/reading-progress.astro";
import RelatedPosts from "@/components/bases/related-posts.astro";
import NewsletterForm from "@/components/bases/newsletter-form.astro";

import { articlesHandler } from "@/lib/handlers/articles";
import { categoriesHandler } from "@/lib/handlers/categories";
import { GISCUS, SITE } from "@/lib/config";
import { authorsHandler } from "@/lib/handlers/authors";
import { generateBreadcrumbSchema, generatePersonSchema } from "@/lib/utils/schemaGenerator";

export const prerender = true;

export const getStaticPaths = async () => {
  const articles = articlesHandler.allArticles();

  return articles.map((article) => ({
    params: { id: article.id },
    props: { article },
  }));
};
const { article } = Astro.props;

const { Content, headings, remarkPluginFrontmatter } = await render(article);
const hasGiscusConfig =
  Boolean(GISCUS.repo) &&
  Boolean(GISCUS.repoId) &&
  Boolean(GISCUS.category) &&
  Boolean(GISCUS.categoryId);
const articleAuthors = authorsHandler.getAuthors(article.data.authors || []);
const publishedISO = new Date(article.data.publishedTime).toISOString();
const modifiedISO = remarkPluginFrontmatter?.lastModified || publishedISO;
const lastModifiedDisplay = remarkPluginFrontmatter?.lastModified || article.data.publishedTime;
const coverUrl = article.data.cover?.src
  ? new URL(article.data.cover.src, SITE.url).toString()
  : undefined;
const canonicalUrl = `${SITE.url}/articles/${article.id}`;

// Get category info for breadcrumb
const categoryRef = article.data.category;
let categoryName = "Danh m·ª•c";
let categoryPath = "";

if (categoryRef && categoryRef.id) {
  try {
    const categoryEntry = await categoriesHandler.oneCategory(categoryRef.id);
    categoryName = categoryEntry?.data?.title || "Danh m·ª•c";
    categoryPath = categoryEntry?.data?.path || "";
  } catch (error) {
    console.warn(`Could not load category ${categoryRef.id}:`, error);
  }
}

// Generate Breadcrumb schema
const breadcrumbItems = [
  { name: "Trang ch·ªß", url: SITE.url },
  { name: "B√†i vi·∫øt", url: `${SITE.url}/articles` },
  ...(categoryPath ? [{ name: categoryName, url: `${SITE.url}/categories/${categoryPath}` }] : []),
  { name: article.data.title, url: canonicalUrl },
];
const breadcrumbSchema = generateBreadcrumbSchema(breadcrumbItems);

// Generate Author schemas
const authorSchemas = articleAuthors.map((author) => generatePersonSchema(author, SITE.url));

const structuredData = {
  "@context": "https://schema.org",
  "@type": "NewsArticle",
  headline: article.data.title,
  description: article.data.description,
  image: coverUrl ? [coverUrl] : undefined,
  author: articleAuthors.map((author) => ({
    "@type": "Person",
    name: author.data.name,
    url: `${SITE.url}/authors/${author.id}`,
  })),
  datePublished: publishedISO,
  dateModified: modifiedISO,
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": canonicalUrl,
  },
  publisher: {
    "@type": "Organization",
    name: SITE.title,
    url: SITE.url,
  },
};
---

<BaseLayout entry={article}>
  <ReadingProgress />
  <!-- NewsArticle Schema -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(structuredData)}></script>
  <!-- BreadcrumbList Schema -->
  <script type="application/ld+json" is:inline set:html={JSON.stringify(breadcrumbSchema)}></script>
  <!-- Author Person Schemas -->
  {authorSchemas.map((authorSchema) => (
    <script type="application/ld+json" is:inline set:html={JSON.stringify(authorSchema)}></script>
  ))}
  
  <div class="container max-w-5xl">
    <Breadcrumb
      items={breadcrumbItems.map((item) => ({
        name: item.name,
        url: item.url,
        current: item.url === canonicalUrl,
      }))}
    />
  </div>

  <ArticleHeader
    article={article}
    readingTime={remarkPluginFrontmatter.minutesRead}
    lastModified={lastModifiedDisplay}
  />
  
  <div class="container max-w-5xl pb-12 space-y-12">
    <div class="space-y-6">
      <ArticleSidebar
        article={article}
        content={Content}
        headings={headings}
        showShare={false}
        showTrending={false}
      />
    </div>

    <div class="space-y-10" data-reading-target>
      <ContentLayout>
        <Content />
        
        <ArticleLink article={article} />
        {hasGiscusConfig && (
          <div class="mt-10">
            <Giscus
              repo={GISCUS.repo}
              repoId={GISCUS.repoId}
              category={GISCUS.category}
              categoryId={GISCUS.categoryId}
              mapping={GISCUS.mapping}
              strict={GISCUS.strict}
              reactionsEnabled={GISCUS.reactionsEnabled}
              emitMetadata={GISCUS.emitMetadata}
              inputPosition={GISCUS.inputPosition}
              theme={GISCUS.theme}
              lang={GISCUS.lang}
            />
          </div>
        )}
      </ContentLayout>

      <!-- Related Posts Section -->
      <RelatedPosts article={article} limit={3} />

      <!-- Share + Trending placed before Newsletter -->
      <ArticleSidebar
        article={article}
        content={Content}
        headings={headings}
        showTOC={false}
      />

      <!-- Newsletter Section -->
      <section class="pt-8 border-t border-base-300 space-y-4">
        <h2 class="text-2xl font-bold text-[color:var(--text-primary)]">
          üìß ƒêƒÉng k√Ω nh·∫≠n tin
        </h2>
        <p class="text-[color:var(--text-muted)]">
          Nh·∫≠n nh·ªØng b√†i vi·∫øt m·ªõi nh·∫•t v√† nh·ªØng l·ªùi khuy√™n h·ªØu √≠ch tr·ª±c ti·∫øp v√†o email c·ªßa b·∫°n.
        </p>
        <NewsletterForm />
      </section>
    </div>
  </div>
</BaseLayout>