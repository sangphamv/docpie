---
interface Props {
  targetSelector?: string;
}

const { targetSelector = "[data-reading-target]" } = Astro.props;
---

<div class="reading-progress" aria-hidden="true" data-reading-progress data-target-selector={targetSelector}>
  <div class="reading-progress__bar" data-reading-progress-bar></div>
</div>

<style>
  .reading-progress {
    position: fixed;
    inset: 0 auto auto 0;
    width: 100%;
    height: 6px;
    background: oklch(var(--bc) / 0.1);
    z-index: 60;
    pointer-events: none;
  }

  .reading-progress__bar {
    height: 100%;
    width: 100%;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 80ms ease-out;
    background: linear-gradient(90deg,
      oklch(var(--p)),
      oklch(var(--a))
    );
    box-shadow: 0 0 0 1px oklch(var(--b1) / 0.3);
  }
</style>

<script is:inline>
  const init = () => {
    const container = document.querySelector('[data-reading-progress]');
    const bar = document.querySelector('[data-reading-progress-bar]');
    const targetSelector = container?.dataset.targetSelector || '[data-reading-target]';
    const target = document.querySelector(targetSelector);
    if (!bar || !target) return;

    let ticking = false;

    const calcProgress = () => {
      const start = target.offsetTop;
      const end = start + target.offsetHeight - window.innerHeight;
      const scrollY = window.scrollY;
      const progressRaw = (scrollY - start) / Math.max(end - start, 1);
      const clamped = Math.min(Math.max(progressRaw, 0), 1);
      bar.style.transform = `scaleX(${clamped})`;
      ticking = false;
    };

    const onScroll = () => {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(calcProgress);
    };

    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', calcProgress);
    document.addEventListener('astro:after-swap', calcProgress);
    calcProgress();
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init, { once: true });
  } else {
    init();
  }
</script>
